<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Build System - CXX-Qt Documentation</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../getting-started/index.html"><strong aria-hidden="true">2.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../getting-started/1-qobjects-in-rust.html"><strong aria-hidden="true">2.1.</strong> QObjects in Rust</a></li><li class="chapter-item expanded "><a href="../getting-started/2-our-first-cxx-qt-module.html"><strong aria-hidden="true">2.2.</strong> Our first CXX-Qt module</a></li><li class="chapter-item expanded "><a href="../getting-started/3-qml-gui.html"><strong aria-hidden="true">2.3.</strong> Creating the QML GUI</a></li><li class="chapter-item expanded "><a href="../getting-started/4-cargo-executable.html"><strong aria-hidden="true">2.4.</strong> Building with Cargo</a></li><li class="chapter-item expanded "><a href="../getting-started/5-cmake-integration.html"><strong aria-hidden="true">2.5.</strong> Building with CMake</a></li></ol></li><li class="chapter-item expanded "><a href="../concepts/index.html"><strong aria-hidden="true">3.</strong> Core Concepts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../concepts/build_systems.html"><strong aria-hidden="true">3.1.</strong> Build Systems</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../concepts/wasm-builds.html"><strong aria-hidden="true">3.1.1.</strong> Building for WebAssembly</a></li></ol></li><li class="chapter-item expanded "><a href="../concepts/generated_qobject.html"><strong aria-hidden="true">3.2.</strong> Generated QObject</a></li><li class="chapter-item expanded "><a href="../concepts/types.html"><strong aria-hidden="true">3.3.</strong> Types</a></li><li class="chapter-item expanded "><a href="../concepts/nested_objects.html"><strong aria-hidden="true">3.4.</strong> Nested Objects</a></li><li class="chapter-item expanded "><a href="../concepts/inheritance.html"><strong aria-hidden="true">3.5.</strong> Inheritance & Overriding</a></li><li class="chapter-item expanded "><a href="../concepts/casting.html"><strong aria-hidden="true">3.6.</strong> Casting</a></li><li class="chapter-item expanded "><a href="../concepts/instantiating_in_rust.html"><strong aria-hidden="true">3.7.</strong> Instantiating in Rust</a></li></ol></li><li class="chapter-item expanded "><a href="../bridge/index.html"><strong aria-hidden="true">4.</strong> Reference: the bridge module</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../bridge/extern_rustqt.html"><strong aria-hidden="true">4.1.</strong> extern "RustQt"</a></li><li class="chapter-item expanded "><a href="../bridge/extern_cppqt.html"><strong aria-hidden="true">4.2.</strong> extern "C++Qt"</a></li><li class="chapter-item expanded "><a href="../bridge/shared_types.html"><strong aria-hidden="true">4.3.</strong> Shared types</a></li><li class="chapter-item expanded "><a href="../bridge/attributes.html"><strong aria-hidden="true">4.4.</strong> Attributes</a></li><li class="chapter-item expanded "><a href="../bridge/traits.html"><strong aria-hidden="true">4.5.</strong> Traits</a></li></ol></li><li class="chapter-item expanded "><a href="../common-issues.html"><strong aria-hidden="true">5.</strong> Common Issues</a></li><li class="chapter-item expanded "><a href="../internals/index.html"><strong aria-hidden="true">6.</strong> For Contributors: CXX-Qt Internals</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../internals/build-system.html" class="active"><strong aria-hidden="true">6.1.</strong> Build System</a></li><li class="chapter-item expanded "><a href="../internals/crate-organization.html"><strong aria-hidden="true">6.2.</strong> Crate Organization</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">CXX-Qt Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!--
SPDX-FileCopyrightText: 2024 KlarÃ¤lvdalens Datakonsult AB, a KDAB Group company <info@kdab.com>
SPDX-FileContributor: Leon Matthes <leon.matthes@kdab.com>

SPDX-License-Identifier: MIT OR Apache-2.0
-->
<h1 id="the-cxx-qt-build-system"><a class="header" href="#the-cxx-qt-build-system">The CXX-Qt Build System</a></h1>
<p>Building with CXX-Qt is somewhat more complicated than it may sound at first.</p>
<h2 id="the-problems-or-challenges-if-you-prefer-corporate-jargon-"><a class="header" href="#the-problems-or-challenges-if-you-prefer-corporate-jargon-">The problems (or &quot;challenges&quot; if you prefer corporate jargon ðŸ˜‰)</a></h2>
<p>We unfortunately cannot simply link your Rust code into a static library and link to it for the following reasons:</p>
<h3 id="static-initializers"><a class="header" href="#static-initializers">Static Initializers</a></h3>
<p>Qt code often contains initialization code that is called by a static variable that runs the initialization code in its constructor.</p>
<p>However, when linking into a static library, and then linking into the main executable, the linker will discard everything from the library that isn't used by the main executable, including these static initializers, as they're never actually used and just exist to run their constructor code.</p>
<h3 id="header-files"><a class="header" href="#header-files">Header files</a></h3>
<p>We want to make the generated headers available, not just to CMake, but also within dependents in the cargo build chain (e.g. your crate will probably want to depend on the headers produced by cxx-qt-lib).</p>
<p>For this we need to export them to a stable directory so that both CMake and Cargo can find them.</p>
<h3 id="optional-integration-with-cmake"><a class="header" href="#optional-integration-with-cmake">(Optional) Integration with CMake</a></h3>
<p>Somehow, all of this should be compatible with both CMake, and Cargo-only builds.</p>
<h2 id="the-plan-for-now"><a class="header" href="#the-plan-for-now">The plan (for now)</a></h2>
<p>After many rounds of refactoring this, we believe that we need to be able to share data between build scripts for this to work halfway ergonomically.</p>
<p>We want to use a similar approach to CXX, which uses Cargos <code>links</code> key to ensure a correct build order (see the <a href="https://doc.rust-lang.org/cargo/reference/build-scripts.html#the-links-manifest-key">links key documentation</a>).
When building with cxx-qt-build, you may simply specify that your code depends on another crate.
Cargo will then make sure that the build scripts of the dependencies have run <strong>before</strong> the build script of this crate.</p>
<p>We can additionally pass metadata between build scripts, which we use to find the <code>manifest.json</code> of each crate and the path to their &quot;target&quot; directory.</p>
<h3 id="the-target-directory"><a class="header" href="#the-target-directory">The &quot;target&quot; directory</a></h3>
<p>Each build script can export artifacts into a folder with a well-known layout.
It is also required to export a <code>manifest.json</code> file that tells downstream dependencies which of these artifacts to include and how to configure their own build.</p>
<p>This &quot;target&quot; directory is usually in the OUT_DIR, but can be exported using <code>CXX_QT_EXPORT_DIR</code> and <code>CXX_QT_EXPORT_CRATE_[crate-name]</code> environment variables.
Which is used by CMake to import the artifacts. (See: <a href="#integration-with-cmake">Integration with CMake</a>)</p>
<h3 id="crates-directory"><a class="header" href="#crates-directory"><code>crates</code> directory</a></h3>
<p>Inside the target directory, there should be a <code>crates</code> folder with one subfolder per crate.
Each crates subfolder should contain the following:</p>
<ul>
<li><code>include/</code>
<ul>
<li><code>crate-name</code> - A folder for all headers that are exported by this crate</li>
<li><code>cxx-qt-lib -&gt; &lt;path-to-dependency&gt;/include/cxx-qt-lib</code> - Symbolic links for every dependency</li>
</ul>
</li>
<li><code>manifest.json</code> - This file describes which headers this library makes available, if it needs any Qt modules, etc.</li>
<li><code>initializers.o</code> - The initializers of this crate + all it's dependencies to be linked in by CMake</li>
</ul>
<p>Via the <code>manifest.json</code>, we are then able to figure out which header paths of this dependency to include, which Qt modules to link, etc.</p>
<p>To make sure the correct data ends up in the manifest.json, we provide the <code>cxx_qt_build::Interface</code> struct which uses the builder pattern to specify all the necessary data.</p>
<h3 id="qml_modules-directory"><a class="header" href="#qml_modules-directory"><code>qml_modules</code> directory</a></h3>
<p>Next to the crates directory, there should be a <code>qml_modules</code> directory, which contains one directory per declared QML module.</p>
<p>Each module should include a <code>plugin_init.o</code>, <code>.qmltypes</code>, <code>qmldir</code>, and any other necessary files.</p>
<h3 id="initializers-with-cargo-and-cmake"><a class="header" href="#initializers-with-cargo-and-cmake">Initializers with Cargo and CMake</a></h3>
<p>There are multiple ways to solve the issues presented by static initializers:</p>
<ul>
<li>Export an object file and link that to the main binary. Object files are always included completely.</li>
<li>Use the whole-archive linker flag which forces inclusion of every object within the static library.
<ul>
<li>If we include the entire static lib generated by cargo, then we'll likely get duplicate symbols, as this really includes <strong>everything</strong> that your Rust code <strong>may</strong> need, even if you don't use it.</li>
<li>This has caused some recent regressions with Rust 1.78+, where MSVC could no longer link CXX-Qt due to duplicate symbols</li>
<li>The way to solve this is to only export the static initializers as a library and link that into CMake.</li>
</ul>
</li>
<li>Manually calling the static initializer code
<ul>
<li>This is basically what Q_INIT_RESOURCE and Q_IMPORT_PLUGIN do</li>
<li>They call the registration method directly, which circumvents the static initializers and forces the static initializers to be linked if they would otherwise be discarded.</li>
</ul>
</li>
</ul>
<p>At the moment we employ a mix of all methods.</p>
<p>First and foremost, we wrap all our initializers into functions with well-defined names (starting with <code>cxx_qt_init</code>) and C-compatible signatures.
This allows us to manually call the initializers from any point in the linker chain, which forces their inclusion.
These initializer functions call the initializer functions from their upstream dependencies so that the entire dependency tree is initialized.</p>
<p>However, we don't want to have to call the initializers manually in every resulting binary.
To solve this, we use static initializers that simply call the initializer function of the crate/Qml module, thereby initializing all dependencies.
As noted earlier, these static initializers are routinely optimized out by the linker.</p>
<p>For Cargo builds we prevent this by linking all initializers with +whole-archive which forces all of them to be included.
Experience has shown that this gives us the best compatibility overall, as linking object files to Cargo builds turned out to be quite finicky.
As the initializers contain very few symbols themselves, this should also rarely lead to issues with duplicate symbols.</p>
<p>In CMake we mirror Qts behavior, which is to build the static initializer as an <code>OBJECT</code> library.
The initializer functions themselves are still built into the Rust static library and the <code>OBJECT</code> library must therefore link to it.
This is taken care of by the <code>cxx_qt_import_crate</code>/<code>_import_qml_module</code> functions.</p>
<h3 id="integration-with-cmake"><a class="header" href="#integration-with-cmake">Integration with CMake</a></h3>
<p>Via the <code>CXXQT_EXPORT_DIR</code> environment variable CMake should be able to change the location of the &quot;target&quot; directory.
CMake can then expect required artifacts to exist at pre-defined locations, which can be added as dependency, include directories, objects, etc. to the Crate target.</p>
<p>We will rely on Corrosion to import the crate and provide targets for it.</p>
<p>However, we also want to provide some custom functions that wrap corrosion and set up the import of our own artifacts.</p>
<p>Currently we provide two functions:</p>
<ul>
<li>cxx_qt_import_crate
<ul>
<li>A wrapper over corrosion_import_crate that defines the <code>CXXQT_EXPORT_DIR</code>, imports the initializers object files, etc.</li>
</ul>
</li>
<li>cxx_qt_import_qml_module
<ul>
<li>Import a given QML module by URI from the given SOURCE_CRATE and provide it as a target.</li>
</ul>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../internals/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../internals/crate-organization.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../internals/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../internals/crate-organization.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
