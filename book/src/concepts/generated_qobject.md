<!--
SPDX-FileCopyrightText: 2022 KlarÃ¤lvdalens Datakonsult AB, a KDAB Group company <info@kdab.com>
SPDX-FileContributor: Andrew Hayzen <andrew.hayzen@kdab.com>

SPDX-License-Identifier: MIT OR Apache-2.0
-->

# The generated QObject

One of the key features of CXX-Qt is the ability to create your own QObjects from Rust.
This is what the [`#[qobject]` macro](../bridge/extern_rustqt.md#qobjects) is for.
This page serves to document the details of what is generated and how to interact with the generated QObject from Rust.

As described in [`extern "RustQt"`](../bridge/extern_rustqt.md#qobjects),
types specified with a `#[qobject]` attribute generate a C++ QObject.
Whilst this QObject is a C++ type, CXX-Qt will automatically wrap it as a [CXX Opaque Type](https://cxx.rs/extern-c++.html#opaque-c-types).
These generated QObjects are accessible to Rust via the CXX bridge.

```rust,ignore,noplayground
#[cxx_qt::bridge]
mod ffi {
    extern "RustQt" {
        #[qobject]
        type MyObject = super::MyObjectRust;
    }
}

#[derive(Default)]
struct MyObjectRust;
```

In this example, `ffi::MyObject` is the C++ QObject type and `MyObjectRust` is the Rust struct.

> You may prefer to call the `#[cxx_qt::bridge]` module `qobject` instead of `ffi`
> as then the C++ QObject type is referred to as `qobject::MyObject`

## Anatomy

Any QObject generated by CXX-Qt is just a C++ QObject subclass that owns an instance of the Rust struct.
The instance of the Rust struct is constructed using its [`Default`](https://doc.rust-lang.org/std/default/trait.Default.html) implementation in the C++ constructor.
Therefore implementing `Default` on the Rust struct is currently mandatory.

The C++ object will defer any property state to the Rust struct, and is therefore only a thin wrapper.
The data for `Q_PROPERTY`s is stored in the Rust struct. The property getters and setters modify the Rust struct internally.

## `impl ffi::T`

As mentioned before, the C++ QObject is exposed to Rust as an opaque CXX type.
This allows you to implement methods for it in Rust using normal `impl` blocks.
Because `ffi::T` is an opaque C++ type, the same rules as with normal CXX opaque types apply.
Most importantly this means that the type may never be accessed by value or by mutable self reference directly.
Rather, all methods must use either `&self` or `self: Pin<&mut Self>` as the self types. This prevents Rust from moving the data in memory, which would invalidate C++ pointers to it.

For more information about pinning, refer to the [pin documentation](https://doc.rust-lang.org/std/pin/).

> This is used to implement [methods](../bridge/extern_rustqt.md#methods) and [invokables](../bridge//extern_rustqt.md#invokables) on the QObject

## Referencing another QObject

For referencing another QObject as a type or property in a CXX-Qt bridge
see the advanced topic on [nesting objects](../advanced/nested_objects.md).

## Access to the Qt thread

Enable [`cxx_qt::Threading` trait](../traits/threading.md) so that you can
queue Rust code to execute on the Qt event loop which the QObject resides in.

This is helpful as the QObject itself does not implement [Send](https://doc.rust-lang.org/std/marker/trait.Send.html) nor [Sync](https://doc.rust-lang.org/std/marker/trait.Sync.html).

See the [`cxx_qt::Threading` trait](../traits/threading.md) for more details.

## Access to internal Rust struct

For every field in the Rust struct, CXX-Qt will generate appropriate getters and setters.
See the [QObject page](../bridge/extern_rustqt.md#properties) for details.

When in the context of the C++ QObject the inner Rust struct can be
accessed by using the [`cxx_qt::CxxQtType` trait](../traits/cxxqttype.md) - which
is implemented automatically for `#[qobject]` marked types defined in a [`extern "RustQt"` bridge](../bridge/extern_rustqt.md#qobjects).
